# sgroupbot
负责消息与频道机器人网关的上下行交互。


1. 通过长链接网关收取消息

2. 主动推送消息


## 使用说明

## 业务逻辑


1. 成语接龙
以对话的形式提供
通过关键词触发成语接龙开始和结束，根据频道创建会话id （如果个人）
接龙完成后，推送接龙情况，有多少用户参与，前几名回答对了几个
同时落库记录接龙会话情况，提供后台接口




2. 主动推送消息

拉取机器人列表，拉取机器人加入的频道，选择频道推送主动消息
提供后台接口，1)拉取机器人 2) 拉取机器人频道，3）根据机器人+频道推送消息，4) 生成消息推送记录，提供查询接口


2. 单体架构

频率限制

https://bot.q.qq.com/wiki/develop/api/openapi/message/post_messages.html

在一个子频道中，默认1s 只能发送5条消息，需要有消息排队机制

已知发送一条消息耗时约200-300ms，也就是说只要控制并发量，则很难触发限制，所以可以使用 '机器人id+子频道id'作为key，推送到并发消息队列即可

单体结构，采用单线程通过任务排队实现
分布式架构，需要有一个单独的消息分发机制，所有消息推送（包括主动与被动），通过将消息推送变为定时任务队列推送，消息网关不保留状态，只负责接收与推送

被动消息注册后为立即推送，相同key的消息间隔100ms 进行推送，推送失败之后间隔100ms再次进行推送，直到消息过期直接丢弃，为了避免任务平台耦合业务逻辑，实际消息推送由消息网关完成，任务平台只负责将任务给到消息网关

3. 分布式架构
默认可以支持消息分片
https://bot.q.qq.com/wiki/develop/api/openapi/wss/shard_url_get.html

1) 分片数量上限通过配置实现，分片应当大于可用实例数量，方便动态扩容，每个实例可以持有0个或多个分片，类似于一致性哈希


