# sgroupbot
一个QQ频道机器人，实现了成语接龙


## 成语接龙

1. 支持群聊，与单聊（沙箱环境需要开发平台添加成员），频道私聊，频道暂时不支持（现在不能创建子频道了）

2. 与机器人对话，群聊通过@触发，机器人默认重复用户所说的内容

3. 通过关键词 "成语接龙" 进入成语接龙的情景，机器人会率先吐出一个成语，用户需要给出接龙的成语并@机器人，机器人判断接龙成立后，会响应新的成语继续接龙

4. 进入情景之后，要么完成成语接龙，或者通过关键词“退出” 主动触发情景退出，否则其它交互一律不响应



## 业务逻辑

1.  以对话的形式提供，通过关键词"成语接龙"触发开始，会根据当前对话形式，创建一个对应的会话对象

2.  会话需要记录上下文信息，单聊（频道私聊）记录用户ID，群聊记录群openid，频道记录子频道id

3. 不同情景（单聊，私聊，群聊，频道）的上下文互不影响，分别单独结算

4. 默认完成5轮接龙退出，可以通过配置调整

5. 长时间无人回答自动超时退出，或者用户主动通过关键词退出

6. 用户回答错误，计 miss+1，每一轮累计miss 3次，直接返回正确结果并进入下一轮

7. 接龙成功，记录该用户命中+1，并且判断用户给到的词能否接龙

8. 如果用户的词无法再接龙，或者接到的下一个词无法再接龙，则接龙结束

9. 多用户并发访问同一个会话时，通过互斥锁实现同步

10. 完结或主动退出后，取出命中数量前3的用户，推送结算消息



## 分布式架构

1. 拆分消息网关与业务逻辑

分离业务逻辑，消息网关只负责收发消息，保证接入点的稳定。

频道网关本身是支持分片的，可以预设足够多的切片，实现网关实例的动态扩缩容

同时可以通过配置化消息网关，实现更为灵活的灰度测试方案。


2. 下行消息限制频率

频道默认限制机器人往指定子频道推消息qps不能大于5， 单体结构适用于消息上下行较少的场景，本身没考虑限频的问题

分布式架构要处理海量请求，必然会频繁触及平台的限流，除了和平台方沟通争取更大的qps 上限之外，势必要做主动限流，确保大部分消息的可达性。

主要的做法是，下行消息推送不直接推送到平台，而是首先推送到任务调度平台。

每条消息都是一个立即执行的任务，携带的唯一key（机器人id+频道id）作为划分队列的标识，相同队列的任务根据预先配置，在同一时间内只有同时有N个任务一起执行（比如每秒5个）


3. 成语接龙

成语接龙本身的状态比较复杂，改分布式有两种做法。

一种是简化逻辑，只保留当前需要接龙的成语，则可以通过redis 共享状态，然后通过cas 操作解决并发竞争。

一种是网游化，做一个单独的集群，每台机器负责管理不同的会话，不同用户访问相同会话时，需要先寻路找到对应的机器。